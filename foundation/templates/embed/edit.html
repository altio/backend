{% extends "embed/object.html" %}
{% load i18n %}

{% block content-footer %}
  <input type="hidden" name="post" value="yes" />
  {% if is_popup %}<input type="hidden" name="{{ is_popup_var }}" value="1" />{% endif %}
  {% if to_field %}<input type="hidden" name="{{ to_field_var }}" value="{{ to_field }}" />{% endif %}
  <button type="submit" class="btn btn-primary">{% trans "Save" %}</button>&nbsp;
  {% if not is_popup and not_is_embed %}<a href="javascript:history.back()" class="btn btn-default">{% trans 'Back' %}</a>{% endif %}
  {% if is_popup %}{% if is_embed %}<button type="button" class="btn btn-default" data-dismiss="modal">{% trans 'Cancel' %}</button>
  {% else %}<a href="javascript:window.close()" class="btn btn-default">{% trans 'Cancel' %}</a>{% endif %}{% endif %}
{{ block.super }}
{% endblock %}


{% extends "embed/edit.html" %}
{% load sekizai_tags %}

{% block embed-submit %}return(submitSearchProfileForm(this)){% endblock %}

{% block embed-body %}
<span id="{{ view.model_name }}_form_edit_button" class="pull-right"><a href="#" class="btn btn-default btn-xs" onclick="editObject(this);"><i class="fa fa-pencil-square-o fa-fw"></i></a></span>
{{ block.super }}
{% endblock %}

{% block embed-scripts %}
<script type="text/javascript">
$(function() {
  var form = $("#{{ view.model_name }}_form")[0];
  {% if form.instance.is_modified %}display{% else %}edit{% endif %}Object(form);
});

var submitSearchProfileForm = function(form) {
  var ret = submitEmbeddedForm(form);
  try {
    refreshSliders();
  } catch(e) {
    
  }
  return ret;
}

</script>
{% endblock %}

<script type="text/javascript">
$(function() {
  var manageEmbed = function(url) {

    /* intercept the default action and handle form failures */
    $('#moveProfile form').submit(function(event) {
      event.preventDefault();

      /* post the embedded form and render errors or dismiss */
      $.ajaxPrefilter(function (settings, originalOptions, xhr) {
          xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
      });
      $.ajax({
        type: "POST",
        url: url,
        data: new FormData($(this)[0]),
        contentType: false,
        processData: false,
      }).done(function(data, textStatus, jqXHR) {
        $('#modal-container .modal-content').html(data);
        var hasErrors = $('#modal-container form').hasClass('form-errors');
        if(hasErrors) {
          /* need to manage submission of the new form (and button) */
          manageModal(url);
        } else {
          $('#modal-container .modal-content').html('');
          $('#modal-container').modal('hide');
          /* for now, be lazy refresh window */
          window.location.reload(true);
        }
      })
    })
  }

  window.onload = function() {

    /* get the triggering element and data attributes */
    // var prospectId = {{ request.user.prospect.pk }};
    // var trigger = $(event.relatedTarget);
    // var url = trigger.data('url');

    /* get the embedded form and render it */
    $.ajax({
      type: "GET",
      url: "{% url 'embed:prospects:prospect:searchprofile:edit' request.user.prospect.pk request.user.prospect.active_search_profile.pk %}",
      contentType: "text/html; charset=utf-8",
    }).done(function(data, textStatus, jqXHR) {
      /* inject the html into the modal */
      $('#searchProfile').html(data);
    });
  };

  //refreshControls();

  $("#features-submit").on("click", function(e) {
    $("#features-edit").hide();
    $("#filters").show();
  });

});

</script>